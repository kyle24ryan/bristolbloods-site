<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Draft Order Reveal • Bristol Bloods</title>
<link rel="icon" href="/assets/favicon.svg" type="image/svg+xml" />

<style>
  :root{
    color-scheme: dark;
    --red:#e11;
    --stack: 680px;         /* desktop/tablet max width */
    --stack-mobile: 380px;  /* phone max width */
  }
  html, body { height:100%; margin:0 }
  body{
    background:#000; color:#fff;
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    display:grid; place-items:center; padding:24px 16px;
  }
  .wrap{
    width:100%; min-height:100dvh;
    display:grid; align-content:center; justify-items:center; row-gap:14px; text-align:center;
  }
  .stack{ width:min(92vw, var(--stack)); }
  @media (max-width:560px){ .stack{ width:min(92vw, var(--stack-mobile)); } }

  /* Logo */
  .logo {
    margin-bottom: 4px;
    max-width: 240px;   /* keep it modest on desktop */
  }
  .logo picture { display:block }
  .logo img {
    width:100%; height:auto; display:block;
  }
  @media (max-width:560px){
    .logo {
      max-width: 160px;   /* smaller on phones */
    }
    .logo img { content:url("/assets/logo-red-stacked.svg"); }
  }

  .sub{ color:#bdbdbd; font-weight:600; margin:0 0 6px }
  .greet{ font-size: clamp(18px, 3.6vw, 28px); font-weight:800; margin:4px 0 10px }

  /* Reveal control */
  .reveal{
    width:100%; display:flex; justify-content:center; align-items:stretch; gap:10px;
  }
  .btn{
    box-sizing:border-box; padding:14px 18px;
    border:1px solid var(--red); background:var(--red); color:#fff;
    border-radius:12px; font-weight:800; cursor:pointer;
    transition: filter .2s ease, transform .08s ease;
  }
  .btn:hover{ filter:brightness(1.05) }
  .btn:active{ transform:scale(.98) }
  .btn[disabled]{ opacity:.6; cursor:not-allowed }

  /* Loader */
  .loader { display:none; gap:10px; align-items:center; justify-content:center; color:#aaa; }
  .spinner {
    width:18px; height:18px; border-radius:50%;
    border:3px solid #333; border-top-color:#fff; animation: spin .8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg) } }

  /* Image card */
  .card{
    width:100%;
    background:#0b0b0b; border:1px solid #141414; border-radius:14px;
    padding:12px; display:none;
  }
  .card img{ width:100%; height:auto; display:block; border-radius:10px; background:#000 }
  .meta{
    display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center;
    margin-top:10px; color:#999; font-size:13px;
  }
  .link, .link:visited { color:#9cf; text-decoration:none; }
  .link:hover{ text-decoration:underline }

  .nav{
    display:grid; grid-template-columns: repeat(2, 1fr); gap:12px;
    width:100%; margin-top:8px;
  }
  .ghost{
    display:flex; align-items:center; justify-content:center;
    padding:12px; border-radius:12px; background:#151515; color:#fff;
    border:1px solid #2a2a2a; text-decoration:none; font-weight:800;
  }
  .ghost:hover{ border-color:#3a3a3a }
</style>

<div class="wrap">
  <!-- Logo -->
  <div class="logo stack">
    <picture>
      <source srcset="/assets/logo-red-stacked.svg" media="(max-width: 560px)">
      <img src="/assets/logo-red-wide.svg" alt="Bristol Bloods">
    </picture>
  </div>

  <!-- Subtitle + Greeting -->
  <div class="sub stack">Draft Order Reveal</div>
  <div id="greet" class="greet stack"></div>

  <!-- Reveal control -->
  <div class="reveal stack" id="controls">
    <button id="revealBtn" class="btn">Reveal my fate</button>
  </div>

  <!-- Loader -->
  <div id="loading" class="loader stack" aria-live="polite">
    <div class="spinner" aria-hidden="true"></div>
    <div id="loadingText">Summoning the AI, sharpening the knives…</div>
  </div>

  <!-- Image result -->
  <div id="result" class="card stack">
    <img id="cardImg" alt="Draft reveal card" />
    <div class="meta">
      <span id="stamp"></span>
      <a id="canon" class="link" target="_blank" rel="noopener">Open image URL</a>
    </div>
    <div class="nav">
      <a class="ghost" href="/overview/">See how the rest of these losers made out →</a>
      <a class="ghost" href="/">Back to home</a>
    </div>
  </div>
</div>

<script>
  const API = "https://api.bristolbloods.com";

  // --- helpers ---
  const qs = new URLSearchParams(location.search);
  const rawName = (qs.get("name") || "").trim();
  const name = rawName || "";

  const greetEl  = document.getElementById('greet');
  const btn      = document.getElementById('revealBtn');
  const loading  = document.getElementById('loading');
  const loadingText = document.getElementById('loadingText');
  const card     = document.getElementById('result');
  const imgEl    = document.getElementById('cardImg');
  const stamp    = document.getElementById('stamp');
  const canon    = document.getElementById('canon');

  // Title-case for display
  function titleCaseName(raw) {
    return (raw || "")
      .trim()
      .toLowerCase()
      .split(/\s+/)
      .map(part =>
        part.split(/([-'])/).map(seg =>
          seg && /[a-z]/.test(seg[0]) ? seg[0].toUpperCase() + seg.slice(1) : seg
        ).join("")
      )
      .join(" ");
  }
  function normalizeSlug(n){ return (n||"").trim().toLowerCase().replace(/\s+/g,'-'); }

  // Person-specific greetings
  const PERSONAL_GREETINGS = {
    "james":  "{name}, ready to run it back?",
    "erica":  "{name}, who are you splitting the pot with this year?",
    "chino":  "{name}, how many weeks until you give up this year?",
    "justin": "Glad you stuck around, {name}! Maybe you can draft someone worth keeping this year?",
    "tommy":  "Stay the fuck away from my draft position, {name}!",
    "tom":    "Stay the fuck away from my draft position, {name}!",
    "thomas": "Stay the fuck away from my draft position, {name}!",
  };

  // Savage greetings
  const SAVAGE_GREETINGS = [
    "Ready to embarrass yourself again, {name}?",
    "Welcome to your annual humiliation, {name}.",
    "Hope you stretched, {name}—you’ll be reaching for waivers by Week 2.",
    "Step right up, {name}—the pain train has no brakes.",
    "Big reveal energy, {name}. Tiny chance of dignity.",
    "Let’s see how fast you tilt this year, {name}.",
    "Brace yourself, {name}. The draft board is about to bully you."
  ];

  // Button blurbs
  const NEGATIVE_BUTTONS = [
    "Reveal my fate",
    "Spin the wheel of shame",
    "Show me my doom",
    "Draft me dirty",
    "Let’s see the carnage",
    "Unveil the humiliation",
    "Deal me my pain",
    "Destroy my hope",
    "Tell me I’m fucked",
    "Hand me the L",
    "Kick me while I’m down",
    "Serve me disappointment"
  ];
  const POSITIVE_BUTTONS = [
    "Crown me champ early",
    "Let’s see my dynasty",
    "Load up the trophy",
    "Bless me with greatness"
  ];

  function pickGreeting(raw) {
    const display = titleCaseName(raw);
    const key = (raw || "").trim().toLowerCase();
    const tpl = PERSONAL_GREETINGS[key] ||
                SAVAGE_GREETINGS[Math.floor(Math.random() * SAVAGE_GREETINGS.length)];
    return tpl.replaceAll("{name}", display || "Stranger");
  }

  function pickButtonBlurb() {
    // 20% chance positive, otherwise savage
    if (Math.random() < 0.2) {
      return POSITIVE_BUTTONS[Math.floor(Math.random() * POSITIVE_BUTTONS.length)];
    } else {
      return NEGATIVE_BUTTONS[Math.floor(Math.random() * NEGATIVE_BUTTONS.length)];
    }
  }

  function show(el, yes){ el.style.display = yes ? "" : "none"; }

  function setStamp(){
    const dt = new Date();
    stamp.textContent = "Revealed " + dt.toLocaleString();
  }

  // --- init text ---
  greetEl.textContent = pickGreeting(name);
  btn.textContent = pickButtonBlurb();

  // If no name, send them back politely
  if(!name){
    btn.textContent = "Go back and type your name";
    btn.onclick = () => { location.href = "/"; };
  } else {
    btn.onclick = async () => {
      try {
        btn.disabled = true;
        show(loading, true);
        loadingText.textContent = "Rolling the ball… painting your shame…";

        const res = await fetch(`${API}/reveal?name=${encodeURIComponent(name)}`, {
          method: "GET",
          mode: "cors"
        });
        if(!res.ok){
          const msg = await res.text().catch(()=>res.statusText);
          throw new Error(`Reveal failed (${res.status}): ${msg}`);
        }

        const blob = await res.blob();
        const url  = URL.createObjectURL(blob);
        imgEl.src = url;

        const slug = normalizeSlug(name);
        const canonUrl = `${API}/image/${slug}.png`;
        canon.href = canonUrl;
        canon.textContent = canonUrl;

        setStamp();
        show(loading, false);
        show(card, true);
        document.getElementById('controls').style.display = 'none';
      } catch (err){
        show(loading, false);
        alert((err && err.message) ? err.message : "Something broke. Try again.");
        btn.disabled = false;
      }
    };
  }
</script>
