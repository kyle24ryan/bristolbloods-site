<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Draft Order Reveal • Bristol Bloods</title>
<link rel="icon" href="/assets/favicon.svg" type="image/svg+xml" />

<style>
  :root{
    color-scheme: dark;
    --red:#e11;
    --stack: 680px;         /* desktop/tablet max width */
    --stack-mobile: 380px;  /* phone max width */
    --head: 0px;            /* header height (set by JS) */
  }
  html, body { height:100%; margin:0 }
  body{
    background:#000; color:#fff;
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    display:block;
    padding:24px 16px;
  }
  body.has-header{ padding-top: calc(var(--head) + 8px); }

  /* ===== Header (matches other pages) ===== */
  header {
    display:none;                 /* start hidden; shown via showHeader() */
    position:fixed; top:0; left:0; right:0; z-index:10;
    padding:12px 20px 10px;
    border-bottom:1px solid #151515;
    background:#000;
    align-items:center; justify-content:space-between; gap:14px; /* flex set in JS */
  }
  .brand { display:flex; align-items:center; }
  .brand img { height: clamp(28px, 5vw, 44px); width:auto; display:block; }
  nav { display:flex; align-items:center; gap:18px; }
  nav a {
    color:#cfcfcf; text-decoration:none; font-size:14px; padding:6px 2px;
    border-bottom:2px solid transparent; transition:border-color .15s,color .15s;
  }
  nav a:hover { color:#fff; border-color:#ff3b3b; }
  nav a[aria-current="page"] { color:#fff; border-color:#ff3b3b; }
  @media (max-width:520px){ header{ justify-content:center; } .brand{ display:none } }

  /* ===== Layout ===== */
  .wrap{
    width:100%;
    min-height: calc(100dvh - var(--head) - 8px);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    gap:14px; text-align:center;
  }
  .stack{ width:min(92vw, var(--stack)); margin-inline:auto; }
  @media (max-width:560px){ .stack{ width:min(92vw, var(--stack-mobile)); } }

  /* Logo */
  .logo { margin-top: 8px; margin-bottom: 4px; max-width: 300px; }
  .logo picture { display:block }
  .logo img { width:100%; height:auto; display:block; }
  @media (max-width:560px){
    .logo { max-width: 400px; }
    .logo img { content:url("/assets/logo-red-stacked.svg"); }
    .greet{ max-width: 30ch; margin-left:auto; margin-right:auto; }
  }

  .sub{ color:#bdbdbd; font-weight:600; margin:0 0 6px }
  .greet{ font-size: clamp(18px, 3.6vw, 28px); font-weight:800; margin:4px 0 10px }

  /* Reveal control */
  .reveal{
    width:100%; display:flex; justify-content:center; align-items:stretch; gap:10px;
  }
  .btn{
    box-sizing:border-box; padding:14px 18px;
    border:1px solid var(--red); background:var(--red); color:#fff;
    border-radius:12px; font-weight:800; cursor:pointer;
    transition: filter .2s ease, transform .08s ease;
    font-size:16px; /* prevent iOS zoom */
  }
  .btn:hover{ filter:brightness(1.05) }
  .btn:active{ transform:scale(.98) }
  .btn[disabled]{ opacity:.6; cursor:not-allowed }

  /* Loader */
  .loader {
    display:none; flex-direction: column; gap:12px;
    align-items:center; justify-content:center; color:#aaa;
  }
  .spinner { width:18px; height:18px; border-radius:50%;
    border:3px solid #330; border-top-color: var(--red); animation: spin .8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg) } }

  /* Image card */
  .card{
    width:100%;
    background:#0b0b0b; border:1px solid #141414; border-radius:14px;
/*     padding:12px;  */
    display:none;
    margin-inline:auto;
  }
  .media { display:flex; align-items:center; justify-content:center; }
  .card img{
    display:block;
    width:auto; height:auto; max-width:100%;
    max-height: min(78vh, 1200px);
    border-radius:10px; background:#000; object-fit:contain; margin-inline:auto;
  }
  .meta{
    display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center;
    margin-top:10px; color:#999; font-size:13px;
  }
  .link, .link:visited { color:#9cf; text-decoration:none; }
  .link:hover{ text-decoration:underline }

  .nav{
    display:grid; grid-template-columns: repeat(2, 1fr); gap:12px;
    width:100%; margin-top:8px;
  }
  .ghost{
    display:flex; align-items:center; justify-content:center;
    padding:12px; border-radius:12px; background:#151515; color:#fff;
    border:1px solid #2a2a2a; text-decoration:none; font-weight:800;
  }
  .ghost:hover{ border-color:#3a3a3a }

  /* Hide the old ghost buttons once the real navbar is visible */
  body.has-header .nav { display:none; }

  .footer {
    position: fixed; 
    right: 12px;
    bottom: 12px;
    z-index: 100;
    opacity: 0.65;          /* subtle, not overpowering */
    transition: opacity 0.2s ease;
  }
  .footer:hover {
    opacity: 1;             /* brighten on hover */
  }
  .footer img {
    height: 26px;           /* small footprint */
    width: auto;
  }
</style>

<!-- Navbar (appears after reveal) -->
<header id="siteHeader" aria-hidden="true">
  <div class="brand"><img src="/assets/logo-red-wide.svg" alt="Bristol Bloods" /></div>
  <nav>
    <a id="navHome"   href="/">Home</a>
    <a id="navKeep"   href="/keepers">Keepers</a>
    <a id="navDraft"  href="/overview">Draft Order</a>
    <a id="navReveal" href="/reveal/" hidden>Reveal Pick</a>
  </nav>
</header>

<div class="wrap">
  <!-- Logo -->
  <div class="logo stack">
    <picture>
      <source srcset="/assets/logo-red-stacked.svg" media="(max-width: 560px)">
      <img src="/assets/logo-red-wide.svg" alt="Bristol Bloods">
    </picture>
  </div>

  <!-- Subtitle + Greeting -->
  <div class="sub stack">Draft Order Reveal</div>
  <div id="greet" class="greet stack"></div>

  <!-- Reveal control -->
  <div class="reveal stack" id="controls">
    <button id="revealBtn" class="btn">Reveal my fate</button>
  </div>

  <!-- Loader -->
  <div id="loading" class="loader stack" aria-live="polite">
    <div class="spinner" aria-hidden="true"></div>
    <div id="loadingText">Summoning the AI, sharpening the knives…</div>
  </div>

  <!-- Image result -->
  <div id="result" class="card stack">
    <div class="media">
      <img id="cardImg" alt="Draft reveal card" />
    </div>
    <div class="meta">
      <span id="stamp"></span>
      <a id="canon" class="link" target="_blank" rel="noopener" style="display:none">Open image URL</a>
    </div>
    <div class="redo">
      <button id="redoBtn" class="btn" style="background:#222;border-color:#333">New image</button>
      <span id="redoLeft" style="color:#aaa;font-size:12px;margin-left:8px"></span>
    </div>
    <div class="nav">
      <a class="ghost" href="/overview/">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="margin-right:6px">
          <path d="M8 6h13M8 12h13M8 18h13M3 6h1M3 12h1M3 18h1" stroke="#fff" stroke-width="2" stroke-linecap="round"/>
          <text x="2" y="7" font-size="6" fill="#fff" font-family="system-ui, sans-serif">1</text>
          <text x="2" y="13" font-size="6" fill="#fff" font-family="system-ui, sans-serif">2</text>
          <text x="2" y="19" font-size="6" fill="#fff" font-family="system-ui, sans-serif">3</text>
        </svg>
        Draft Order
      </a>
      <a class="ghost" href="/">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true" style="margin-right:6px">
          <path d="M3 12l9-9 9 9M5 10v10h14V10" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        Home
      </a>
    </div>
  </div>
</div>

<!-- Footer -->
<footer class="footer">
  <img src="/assets/techridy.png" alt="Powered by Techridy" />
</footer>

<script>
  const API = "https://api.bristolbloods.com";

  // Header helpers
  const headerEl = document.getElementById('siteHeader');
  function showHeader() {
    headerEl.style.display = 'flex';               // show
    headerEl.style.display = 'flex';               // ensure flex layout
    headerEl.removeAttribute('aria-hidden');
    const h = headerEl.offsetHeight || 0;
    document.documentElement.style.setProperty('--head', h + 'px');
    document.body.classList.add('has-header');

    // after showing, wire nav (so sizes are final)
    setupRevealTab();
    setActiveNav();
  }
  addEventListener('resize', () => {
    if (headerEl.style.display !== 'none') {
      const h = headerEl.offsetHeight || 0;
      document.documentElement.style.setProperty('--head', h + 'px');
    }
  });

  const redoBtn  = document.getElementById('redoBtn');
  const redoLeft = document.getElementById('redoLeft');
  
  function setRedoLabel(n){
    if (typeof n === 'number') {
      redoLeft.textContent = `(${n} left)`;
      redoBtn.disabled = n <= 0;
    }
  }
  
  redoBtn.addEventListener('click', async () => {
    if (!name) return;
    redoBtn.disabled = true;
    startLoading();
    imgEl.hidden = true;
  
    try {
      const res = await fetch(`${API}/regenerate`, {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ name })
      });
      const data = await res.json();
      if (!res.ok || !data.ok) {
        stopLoading();
        redoBtn.disabled = false;
        alert(data?.error || 'Failed to regenerate');
        if (typeof data?.remaining === 'number') setRedoLabel(data.remaining);
        return;
      }
  
      setRedoLabel(data.remaining);
  
      // Bust cache and swap in the freshly overwritten PNG from R2
      const slug = (name || "").trim().toLowerCase().replace(/\s+/g,'-');
      imgEl.src = `${API}/image/${slug}.png?cb=${Date.now()}`;
      imgEl.onload = () => {
        stopLoading();
        imgEl.hidden = false;
        redoBtn.disabled = data.remaining <= 0;
      };
    } catch (e) {
      stopLoading();
      redoBtn.disabled = false;
      alert('Could not regenerate. Try again.');
    }
  });

  // --- DOM refs ---
  const qs        = new URLSearchParams(location.search);
  const rawName   = (qs.get("name") || "").trim();
  const name      = rawName || "";

  const logo      = document.querySelector('.logo');
  const greetEl   = document.getElementById('greet');
  const btn       = document.getElementById('revealBtn');
  const loading   = document.getElementById('loading');
  const loadingText = document.getElementById('loadingText');
  const card      = document.getElementById('result');
  const imgEl     = document.getElementById('cardImg');
  const stamp     = document.getElementById('stamp');
  const canon     = document.getElementById('canon');
  const controls  = document.getElementById('controls');
  const subtitle  = document.querySelector('.sub');

  // image decode hints
  imgEl.decoding = "async";
  imgEl.loading  = "eager";

  function titleCaseName(raw) {
    return (raw || "").trim().toLowerCase().split(/\s+/).map(part =>
      part.split(/([-'])/).map(seg =>
        seg && /[a-z]/.test(seg[0]) ? seg[0].toUpperCase() + seg.slice(1) : seg
      ).join("")
    ).join(" ");
  }
  function normalizeSlug(n){ return (n||"").trim().toLowerCase().replace(/\s+/g,'-'); }
  function setStamp(iso) {
    const dt = iso ? new Date(iso) : new Date();
    stamp.textContent = "Revealed " + dt.toLocaleString();
  }

  // Nav: reveal link + active tab
  function setupRevealTab(){
    const a = document.getElementById('navReveal');
    if (!a) return;
    if (name) {
      a.href = `/reveal/?name=${encodeURIComponent(name)}`;
      a.hidden = false;
    } else if (location.pathname.startsWith('/reveal')) {
      a.hidden = false;
    }
  }
  function setActiveNav(){
    const path = location.pathname.replace(/\/+$/,'');
    const map = new Map([
      ['','navHome'],
      ['/keepers','navKeep'],
      ['/draft','navDraft'],
    ]);
    let id = map.get(path) || null;
    if (path.startsWith('/reveal')) id = 'navReveal';
    document.querySelectorAll('header nav a[aria-current]').forEach(a => a.removeAttribute('aria-current'));
    if (id) document.getElementById(id)?.setAttribute('aria-current','page');
  }

  const PERSONAL_GREETINGS = {
    "james":  "{name}, ready to run it back?",
    "erica":  "{name}, who are you splitting the pot with this year?",
    "chino":  "{name}, how many weeks until you give up this year?",
    "justin": "Glad you stuck around, {name}! Maybe you can draft someone worth keeping this year?",
    "tommy":  "Stay the fuck away from my draft position, {name}!",
    "tom":    "Stay the fuck away from my draft position, {name}!",
    "thomas": "Stay the fuck away from my draft position, {name}!",
  };
  const SAVAGE_GREETINGS = [
    "Ready to embarrass yourself again, {name}?",
    "Welcome to your annual humiliation, {name}.",
    "Hope you stretched, {name}—you’ll be reaching for waivers by Week 2.",
    "Step right up, {name}—the pain train has no brakes.",
    "Big reveal energy, {name}. Tiny chance of dignity.",
    "Let’s see how fast you tilt this year, {name}.",
    "Brace yourself, {name}. The draft board is about to bully you."
  ];
  function pickGreeting(raw) {
    const display = titleCaseName(raw);
    const key = (raw || "").trim().toLowerCase();
    const tpl = PERSONAL_GREETINGS[key] ||
                SAVAGE_GREETINGS[Math.floor(Math.random() * SAVAGE_GREETINGS.length)];
    return tpl.replaceAll("{name}", display || "Stranger");
  }

  const NEGATIVE_BUTTONS = [
    "Reveal my fate","Spin the wheel of shame","Show me my doom","Draft me dirty",
    "Let’s see the carnage","Unveil the humiliation","Deal me my pain","Destroy my hope",
    "Tell me I’m fucked","Hand me the L","Kick me while I’m down","Serve me disappointment"
  ];
  const POSITIVE_BUTTONS = [
    "Crown me champ early","Let’s see my dynasty","Load up the trophy","Bless me with greatness"
  ];
  function pickButtonBlurb() {
    return Math.random() < 0.2
      ? POSITIVE_BUTTONS[Math.floor(Math.random() * POSITIVE_BUTTONS.length)]
      : NEGATIVE_BUTTONS[Math.floor(Math.random() * NEGATIVE_BUTTONS.length)];
  }

  async function fetchSlotAndTime(name) {
    try {
      const res = await fetch(`${API}/state`, { cache: "no-store" });
      if (!res.ok) return { slot: null, revealedAt: null };
      const rows = await res.json();
      const slug = (name || "").trim().toLowerCase().replace(/\s+/g,'-');
      const me = rows.find(r => r.slug === slug);
      return { slot: me?.slot ?? null, revealedAt: me?.revealedAt ?? null };
    } catch {
      return { slot: null, revealedAt: null };
    }
  }

  function critique(slot, displayName) {
    const n = displayName || "You";
    if (slot === 1)  return `${n}, pick #1 — enjoy it while it lasts. No excuses now.`;
    if (slot === 12) return `${n}, pick #12 — snake blessings. Try not to waste the double tap.`;
    if (slot <= 3)   return `Pick #${slot} — premium spot. Even you can’t mess *this* up… probably.`;
    if (slot <= 5)   return `Pick #${slot} — early enough to dream, late enough to blame the board.`;
    if (slot <= 8)   return `Pick #${slot} — solid middle-upper. You’ll still find a way to tilt.`;
    if (slot <= 10)  return `Pick #${slot} — mid-pack misery. Out-draft or out-whine: your choice.`;
    return `Pick #${slot} — enjoy the scraps, ${n}. Waiver wire is your new best friend.`;
  }

  // --- Initial UI state
  const displayName = titleCaseName(name);
  if (name) {
    document.getElementById('greet').textContent = pickGreeting(name);
    document.getElementById('greet').hidden = false;
  } else {
    document.getElementById('greet').hidden = true;
  }
  document.getElementById('revealBtn').textContent = pickButtonBlurb();

  // Loading text escalator
  let _loadingTimers = [];
  function startLoading() {
    loading.style.display = "flex";
    loadingText.textContent = "Summoning your draft card…";
    const steps = [
      [3000,  "Still working… greatness (or disaster) takes time."],
      [7000,  "AI is arguing with itself about how ugly you are."],
      [12000, "Almost there. It’s carefully crafting your public humiliation."],
      [20000, "Calm down, {name}, even Michelangelo took his time."],
      [30000, "The pixels are unionized. They’re on a smoke break."],
      [45000, "Almost halftime. Hope your patience lasts longer than your season."],
      [60000, "Good news: it’s not frozen. Bad news: neither is your roster."],
      [75000, "It’s painting every hair on your chin with Pixar precision."],
      [90000, "Okay fine, it’s taking forever. But hey—so will your rebuild."],
    ];
    _loadingTimers = steps.map(([ms, msg]) =>
      setTimeout(() => (loadingText.textContent = msg.replace("{name}", titleCaseName(name))), ms)
    );
  }
  function stopLoading() {
    loading.style.display = "none";
    _loadingTimers.forEach(clearTimeout);
    _loadingTimers = [];
  }

  // No name? Send home
  if (!name) {
    document.getElementById('revealBtn').textContent = "Go back and type your name";
    document.getElementById('revealBtn').onclick = () => { location.href = "/"; };
  } else {
    document.getElementById('revealBtn').onclick = () => {
      document.getElementById('revealBtn').disabled = true;
      controls.style.display = 'none';
      loading.style.display = 'flex';
      startLoading();

      if (logo) logo.style.display = '';
      if (subtitle) subtitle.style.display = '';
      card.style.display = 'none';
      imgEl.hidden = true;
      greetEl.hidden = true;

      imgEl.onload = async () => {
        stopLoading();
        imgEl.hidden = false;
        card.style.display = "block";

        // Hide logo/subtitle so the image card is the focus
        if (logo) logo.style.display = 'none';
        if (subtitle) subtitle.style.display = 'none';

        // Show the navbar (with logo) and adjust layout; wire its links/active state
        showHeader();

        const { slot, revealedAt } = await fetchSlotAndTime(name);
        setStamp(revealedAt);
        const displayName = titleCaseName(name);
        greetEl.textContent = slot
          ? critique(slot, displayName)
          : "Revealed. If the pick sucks, blame latency.";
        greetEl.hidden = false;
      };

      imgEl.onerror = () => {
        stopLoading();
        alert(`Could not load card for "${name}". Try again.`);
        document.getElementById('revealBtn').disabled = false;
        if (logo) logo.style.display = '';
      };

      imgEl.src = `${API}/reveal?name=${encodeURIComponent(name)}&cb=${Date.now()}`;
    };

    if (qs.get("autoplay") === "1") document.getElementById('revealBtn').click();
  }
</script>
