<!doctype html>
<meta charset="utf-8" />
<title>Bristol Bloods — Draft Order</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root { color-scheme: dark }
  body { margin:0; background:#000; color:#fff; font:16px/1.4 system-ui; }

  /* Header as 2-row grid */
  header {
    padding:16px 20px;
    border-bottom:1px solid #151515;
    display:grid;
    grid-template-columns: 1fr auto;
    grid-template-rows: auto auto;
    align-items:center;
    gap:6px 14px;
  }
  .brand { grid-column: 1 / 2; grid-row: 1; display:flex; align-items:center; }
  .brand img.logo {
    height: clamp(26px, 4.5vw, 40px);
    width: auto;
    display:block;
  }
  .stamp { grid-column: 2 / 3; grid-row: 1; color:#aaa; font-size:13px; white-space:nowrap; }
  .title { grid-column: 1 / 3; grid-row: 2; display:flex; align-items:baseline; gap:10px; flex-wrap:wrap; }
  .h1like { font-size:clamp(20px,2.8vw,28px); font-weight:700; margin:0; }
  .muted { color:#999; font-size:13px; }

  /* Fixed 2x6 grid, always two columns */
  .grid {
    display:grid; gap:16px; padding:16px;
    grid-template-columns: repeat(2, 1fr);
    max-width: 1000px; margin: 0 auto;
  }

  .card {
    background:#0b0b0b; border:1px solid #141414; border-radius:12px; padding:10px;
    display:flex; flex-direction:column; align-items:center;
    will-change: transform, opacity;
  }
  .slot { font-weight:800; margin:6px 0 8px; color:#ff3b3b; letter-spacing:.2px; }
  .name { margin-top:8px; font-weight:700; text-align:center; }
  .ph {
    width:100%; aspect-ratio:1/1; border-radius:10px; background:
      repeating-linear-gradient(45deg, #0f0f0f, #0f0f0f 10px, #111 10px, #111 20px);
    display:grid; place-items:center; color:#777; font-weight:700;
  }
  .imgbox { width:100%; aspect-ratio:1/1; border-radius:10px; overflow:hidden; background:#000; }
  img { width:100%; height:100%; object-fit:cover; display:block; }

  /* Slower reveal animations */
  @media (prefers-reduced-motion: no-preference) {
    .flip-in { animation: flipIn .9s cubic-bezier(.2,.7,.2,1) both; }
    .fade-up { animation: fadeUp .7s ease-out both; }
    @keyframes flipIn {
      from { transform: rotateY(-90deg) scale(.96); opacity: 0; }
      to   { transform: rotateY(0) scale(1);        opacity: 1; }
    }
    @keyframes fadeUp {
      from { transform: translateY(8px); opacity: 0; }
      to   { transform: translateY(0);   opacity: 1; }
    }
  }
</style>

<header>
  <!-- Row 1 -->
  <div class="brand">
    <img class="logo" src="/assets/logo-red-wide.svg" alt="Bristol Bloods" />
  </div>
  <div id="stamp" class="stamp" aria-live="polite">Last updated: —</div>

  <!-- Row 2 -->
  <div class="title">
    <div class="h1like">— Draft Order</div>
    <div class="muted">Fills in as each coward braves the reveal.</div>
  </div>
</header>

<section class="grid" id="grid" aria-label="Draft order, two columns"></section>

<script>
const API = "https://api.bristolbloods.com";
const LEAGUE_SIZE = 12;
const REFRESH_MS = 120000; // 2 minutes

let pollTimer = null;
let isFrozen = false;

function tcase(s){ return s.replace(/\b\w/g, c => c.toUpperCase()); }

function placeholder(slot) {
  const el = document.createElement('div');
  el.className = 'card';
  el.innerHTML = `
    <div class="slot">Pick #${slot}</div>
    <div class="ph">Awaiting reveal…</div>
    <div class="name muted">—</div>
  `;
  return el;
}

function updateStamp(text) {
  const el = document.getElementById('stamp');
  el.textContent = text;
}

async function load() {
  const grid = document.getElementById('grid');
  grid.innerHTML = "";
  const slots = new Map();
  for (let i = 1; i <= LEAGUE_SIZE; i++) {
    const el = placeholder(i);
    grid.appendChild(el);
    slots.set(i, el);
  }

  let rows = [];
  try {
    const res = await fetch(`${API}/state`, { cache: "no-store" });
    rows = await res.json();
  } catch (e) {
    console.error("state fetch failed", e);
  }

  for (const r of rows) {
    const el = slots.get(Number(r.slot));
    if (!el) continue;

    el.innerHTML = `
      <div class="slot">Pick #${r.slot}</div>
      <div class="imgbox">
        <img loading="lazy" src="${API}${r.imageUrl}" alt="${tcase(r.name)}" class="flip-in" />
      </div>
      <div class="name fade-up">${tcase(r.name)}</div>
    `;
  }

  const revealedCount = rows.filter(r => r.imageUrl && String(r.imageUrl).trim() !== "").length;
  const now = new Date();
  const time = new Intl.DateTimeFormat(undefined, {
    hour: 'numeric', minute: '2-digit', second: '2-digit'
  }).format(now);

  if (revealedCount >= LEAGUE_SIZE && !isFrozen) {
    isFrozen = true;
    if (pollTimer) clearInterval(pollTimer);
    updateStamp(`All picks revealed — frozen at ${time}`);
  } else if (!isFrozen) {
    updateStamp(`Last updated: ${time}`);
  }
}

async function start() {
  await load();
  if (!isFrozen) {
    pollTimer = setInterval(load, REFRESH_MS);
  }
}

start();
</script>
