<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Draft Order Reveal • Bristol Bloods</title>
<link rel="icon" href="/assets/favicon.svg" type="image/svg+xml" />

<style>
  :root{
    color-scheme: dark;
    --red:#e11;
    --stack: 680px;         /* desktop/tablet max width */
    --stack-mobile: 380px;  /* phone max width */
  }
  html, body { height:100%; margin:0 }
  body{
    background:#000; color:#fff;
    font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    display:grid; place-items:center; padding:24px 16px;
  }
  .wrap{
    width:100%; min-height:100dvh;
    display:grid; align-content:center; justify-items:center; row-gap:14px; text-align:center;
  }
  .stack{ width:min(92vw, var(--stack)); }
  @media (max-width:560px){ .stack{ width:min(92vw, var(--stack-mobile)); } }

  /* Logo */
  .logo { margin-bottom: 4px; max-width: 300px; }
  .logo picture{ display:block }
  .logo img{ width:100%; height:auto; display:block }
  @media (max-width:560px){
    .logo { max-width: 200px; }
    .logo img{ content:url("/assets/logo-red-stacked.svg"); }
  }

  .sub{ color:#bdbdbd; font-weight:600; margin:0 0 6px }
  .greet{
    font-size: clamp(18px, 3.6vw, 28px);
    font-weight:800;
    margin:10px auto 10px;
    max-width: 32ch;             /* keeps it from feeling too wide */
  }
  @media (min-width:900px){ .greet{ max-width: 40ch } }

  /* Controls area: button OR spinner/message occupy same spot */
  .controls{ width:100%; display:grid; justify-items:center }
  .reveal{ display:inline-grid; grid-template-columns: 1fr auto; gap:10px; }
  @media (max-width:560px){ .reveal{ grid-template-columns: 1fr } }

  .btn{
    box-sizing:border-box; padding:14px 18px;
    border:1px solid var(--red); background:var(--red); color:#fff;
    border-radius:12px; font-weight:800; cursor:pointer;
    transition: filter .2s ease, transform .08s ease;
  }
  .btn:hover{ filter:brightness(1.05) }
  .btn:active{ transform:scale(.98) }
  .btn[disabled]{ opacity:.6; cursor:not-allowed }

  /* Loader (sits where the button was) */
  .loader {
    display:none;
    grid-auto-flow: row;
    align-items:center;
    justify-items:center;
    row-gap:12px;
    margin-top: 4px;
  }
  .spinner {
    width:22px; height:22px; border-radius:50%;
    border:3px solid #333; border-top-color:#fff; animation: spin .8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg) } }
  .loading-copy{ color:#aaa; max-width: 36ch }

  /* Image card */
  .card{
    width:100%; background:#0b0b0b; border:1px solid #141414; border-radius:18px;
    padding:14px; display:none;
    box-shadow: 0 10px 40px rgba(0,0,0,.35);
  }
  .card img{ width:100%; height:auto; display:block; border-radius:12px; background:#000 }
  .meta{ margin-top:10px; color:#999; font-size:13px }

  .nav{
    display:grid; grid-template-columns: repeat(2, 1fr); gap:12px;
    width:100%; margin-top:12px;
  }
  .ghost{
    display:flex; align-items:center; justify-content:center; gap:10px;
    padding:12px; border-radius:12px; background:#151515; color:#fff;
    border:1px solid #2a2a2a; text-decoration:none; font-weight:800;
  }
  .ghost:hover{ border-color:#3a3a3a }

  .icon{ width:18px; height:18px; display:inline-block; }
</style>

<div class="wrap">
  <!-- Logo -->
  <div class="logo stack" id="logoWrap">
    <picture>
      <source srcset="/assets/logo-red-stacked.svg" media="(max-width: 560px)">
      <img src="/assets/logo-red-wide.svg" alt="Bristol Bloods">
    </picture>
  </div>

  <!-- Subtitle + Greeting -->
  <div class="sub stack" id="subtitle">Draft Order Reveal</div>
  <div id="greet" class="greet stack"></div>

  <!-- Controls (button OR loader live here) -->
  <div class="controls stack" id="controls">
    <div class="reveal" id="revealRow">
      <button id="revealBtn" class="btn">Reveal my fate</button>
    </div>

    <div id="loading" class="loader" aria-live="polite">
      <div class="spinner" aria-hidden="true"></div>
      <div id="loadingText" class="loading-copy">Summoning your draft card…</div>
    </div>
  </div>

  <!-- Image result -->
  <div id="result" class="card stack">
    <img id="cardImg" alt="Draft reveal card" />
    <div class="meta" id="stamp"></div>

    <div class="nav">
      <a class="ghost" href="/overview/">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M4 21h16M5 17l7-7 7 7M12 10V3" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Draft Order
      </a>
      <a class="ghost" href="/">
        <svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 12l9-9 9 9M5 10v10h14V10" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Home
      </a>
    </div>
  </div>
</div>

<script>
  const API = "https://api.bristolbloods.com";

  // --- DOM refs ---
  const qs        = new URLSearchParams(location.search);
  const rawName   = (qs.get("name") || "").trim();
  const name      = rawName || "";

  const logoWrap  = document.getElementById('logoWrap');
  const subtitle  = document.getElementById('subtitle');
  const greetEl   = document.getElementById('greet');

  const controls  = document.getElementById('controls');
  const revealRow = document.getElementById('revealRow');
  const btn       = document.getElementById('revealBtn');

  const loading   = document.getElementById('loading');
  const loadingText = document.getElementById('loadingText');

  const card      = document.getElementById('result');
  const imgEl     = document.getElementById('cardImg');
  const stamp     = document.getElementById('stamp');

  // Image decode hints (faster paint when we swap)
  imgEl.decoding = "async";
  imgEl.loading  = "eager";

  // ---- Helpers ----
  function titleCaseName(raw) {
    return (raw || "").trim().toLowerCase().split(/\s+/).map(part =>
      part.split(/([-'])/).map(seg =>
        seg && /[a-z]/.test(seg[0]) ? seg[0].toUpperCase() + seg.slice(1) : seg
      ).join("")
    ).join(" ");
  }
  function normalizeSlug(n){ return (n||"").trim().toLowerCase().replace(/\s+/g,'-'); }
  function show(el, yes){ el.style.display = yes ? "" : "none"; }
  function setStamp(){ stamp.textContent = "Revealed " + new Date().toLocaleString(); }

  // Person-specific greetings
  const PERSONAL_GREETINGS = {
    "james":  "{name}, ready to run it back?",
    "erica":  "{name}, who are you splitting the pot with this year?",
    "chino":  "{name}, how many weeks until you give up this year?",
    "justin": "Glad you stuck around, {name}! Maybe you can draft someone worth keeping this year?",
    "tommy":  "Stay the fuck away from my draft position, {name}!",
    "tom":    "Stay the fuck away from my draft position, {name}!",
    "thomas": "Stay the fuck away from my draft position, {name}!",
  };
  const SAVAGE_GREETINGS = [
    "Ready to embarrass yourself again, {name}?",
    "Welcome to your annual humiliation, {name}.",
    "Hope you stretched, {name}—you’ll be reaching for waivers by Week 2.",
    "Step right up, {name}—the pain train has no brakes.",
    "Big reveal energy, {name}. Tiny chance of dignity.",
    "Let’s see how fast you tilt this year, {name}.",
    "Brace yourself, {name}. The draft board is about to bully you."
  ];

  // Button blurbs (80% savage / 20% positive)
  const NEGATIVE_BUTTONS = [
    "Reveal my fate","Spin the wheel of shame","Show me my doom","Draft me dirty",
    "Let’s see the carnage","Unveil the humiliation","Deal me my pain","Destroy my hope",
    "Tell me I’m fucked","Hand me the L","Kick me while I’m down","Serve me disappointment"
  ];
  const POSITIVE_BUTTONS = [
    "Crown me champ early","Let’s see my dynasty","Load up the trophy","Bless me with greatness"
  ];

  function pickGreeting(raw) {
    const display = titleCaseName(raw);
    const key = (raw || "").trim().toLowerCase();
    const tpl = PERSONAL_GREETINGS[key] ||
                SAVAGE_GREETINGS[Math.floor(Math.random() * SAVAGE_GREETINGS.length)];
    return tpl.replaceAll("{name}", display || "Stranger");
  }
  function pickButtonBlurb() {
    return Math.random() < 0.2
      ? POSITIVE_BUTTONS[Math.floor(Math.random() * POSITIVE_BUTTONS.length)]
      : NEGATIVE_BUTTONS[Math.floor(Math.random() * NEGATIVE_BUTTONS.length)];
  }

  async function fetchSlotFor(name) {
    try {
      const res = await fetch(`${API}/state`, { cache: "no-store" });
      if (!res.ok) return null;
      const rows = await res.json(); // [{name, slug, slot, imageUrl}]
      const slug = normalizeSlug(name);
      const me = rows.find(r => r.slug === slug);
      return me?.slot ?? null;
    } catch { return null; }
  }

  function critique(slot, displayName) {
    const n = displayName || "You";
    if (slot === 1)  return `${n}, pick #1 — enjoy it while it lasts. No excuses now.`;
    if (slot === 12) return `${n}, pick #12 — snake blessings. Try not to waste the double tap.`;
    if (slot <= 3)   return `Pick #${slot} — premium spot. Even you can’t mess *this* up… probably.`;
    if (slot <= 5)   return `Pick #${slot} — early enough to dream, late enough to blame the board.`;
    if (slot <= 8)   return `Pick #${slot} — solid middle-upper. You’ll still find a way to tilt.`;
    if (slot <= 10)  return `Pick #${slot} — mid-pack misery. Out-draft or out-whine: your choice.`;
    return `Pick #${slot} — enjoy the scraps, ${n}. Waiver wire is your new best friend.`;
  }

  // --- init greeting + button text
  const displayName = titleCaseName(name);
  greetEl.textContent = pickGreeting(name);
  btn.textContent = pickButtonBlurb();

  // -------- loading copy that escalates --------
  let _loadingTimers = [];
  function startLoading() {
    show(loading, true);
    const steps = [
      [3000,  "Still working… greatness (or disaster) takes time."],
      [7000,  "AI is arguing with itself about how ugly this is."],
      [12000, "Almost there. It’s carefully crafting your public humiliation."]
    ];
    _loadingTimers = steps.map(([ms, msg]) => setTimeout(() => (loadingText.textContent = msg), ms));
  }
  function stopLoading() {
    show(loading, false);
    _loadingTimers.forEach(clearTimeout);
    _loadingTimers = [];
  }

  // No name? Send back to home.
  if (!name) {
    btn.textContent = "Go back and type your name";
    btn.onclick = () => { location.href = "/"; };
  } else {
    btn.onclick = () => {
      // hide button immediately, show loader in same area
      btn.disabled = true;
      revealRow.style.display = 'none';
      startLoading();

      // reset UI
      card.style.display = 'none';
      if (logoWrap) logoWrap.style.display = '';   // keep up until the image actually loads
      if (subtitle) subtitle.style.display = '';   // same as above

      // attach handlers before setting src
      imgEl.onload = async () => {
        stopLoading();
        // now hide logo + subtitle, show card
        if (logoWrap) logoWrap.style.display = 'none';
        if (subtitle) subtitle.style.display = 'none';
        card.style.display = '';

        setStamp();

        // slot-based roast/praise
        try {
          const slot = await fetchSlotFor(name);
          greetEl.textContent = slot ? critique(slot, displayName) : "Revealed. If the pick sucks, blame latency.";
        } catch {
          greetEl.textContent = "Revealed. If the pick sucks, blame latency.";
        }
      };

      imgEl.onerror = () => {
        stopLoading();
        alert(`Could not load card for "${name}". Try again.`);
        btn.disabled = false;
        revealRow.style.display = '';
      };

      // 🔒 Keep the proven, working path: stream PNG from /reveal
      imgEl.src = `${API}/reveal?name=${encodeURIComponent(name)}&cb=${Date.now()}`;
    };

    // Autoplay (works only when ?name= is present)
    if (qs.get("autoplay") === "1") btn.click();
  }
</script>
